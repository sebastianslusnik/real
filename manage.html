<!doctype html>
<html lang="hu">

<head>
	<meta charset="utf-8">
	<title>KomplexIngatlan • Kezelés</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="icon" type="image/png" href="favii.png" />
	<style>
	:root {
		--bg: #fdfaf6;
		--card: #ffffff;
		--muted: #667085;
		--text: #0b1320;
		--primary: #fa943f;
		--primary-600: #ea580c;
		--border: #efe7dc;
		--chip: #fff7ed;
		--ok: #16a34a;
		--err: #dc2626;
		--shadow: 0 12px 28px rgba(16, 24, 40, .08)
	}

	* {
		box-sizing: border-box;
		font-family: 'Inter' !important;
	}

	body {
		margin: 0;
		background: var(--bg);
		color: var(--text);
		font-family: Inter
	}

	a {
		text-decoration: none;
		color: inherit
	}

	.container {
		max-width: 1200px;
		margin: 0 auto;
		padding: 28px 24px
	}

	.header {
		display: flex;
		align-items: center;
		justify-content: space-between;
		margin-bottom: 16px
	}

	.brand {
		display: flex;
		gap: 10px;
		align-items: center
	}

	.logo {
		width: 48px;
		height: 48px;
		border-radius: 50%;
		background-image: url(favii.png);
		background-position: center;
		background-repeat: no-repeat;
		background-size: contain;
	}

	.brand h1 {
		font-size: 18px;
		margin: 0;
		font-weight: 800
	}

	.header a {
		color: #1f2937;
		background: #fff;
		border: 1px solid var(--border);
		padding: 10px 16px;
		border-radius: 8px;
		font-weight: 600;
		font-size: 14px;
	}

	.header a.cta {
		background: var(--primary);
		color: #fff;
		border: none
	}

	.toolbar {
		display: flex;
		gap: 10px;
		flex-wrap: wrap;
		margin-bottom: 25px;
		margin-top: 50px
	}

	input,
	select {
		background: #fff;
		border: 1px solid var(--border);
		color: #0b1320;
		border-radius: 10px;
		padding: 10px 12px;
		font-size: 14px;
		outline: none
	}

	.search {
		flex: 1;
		min-width: 300px
	}

	select {
		min-width: 80px
	}

	.btn {
		appearance: none;
		border: none;
		border-radius: 8px;
		padding: 10px 14px;
		font-weight: 700;
		cursor: pointer;
		background: var(--primary);
		color: #fff
	}

	.status {
		font-size: 13px;
		color: var(--muted);
		margin-top: 2px
	}

	.status.ok {
		color: var(--ok)
	}

	.status.err {
		color: var(--err)
	}

	.grid {
		display: grid;
		grid-template-columns: repeat(3, 1fr);
		gap: 16px
	}

	@media(max-width:1100px) {
		.grid {
			grid-template-columns: repeat(2, 1fr)
		}
	}

	@media(max-width:720px) {
		.grid {
			grid-template-columns: 1fr
		}
	}

	.card {
		background: var(--card);
		border: 1px solid var(--border);
		border-radius: 14px;
		overflow: hidden;
		display: flex;
		flex-direction: column;
		box-shadow: var(--shadow);
		cursor: pointer
	}

	.media {
		position: relative;
		height: 200px;
		background: #fff3e5
	}

	.media img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block
	}

	.badges {
		position: absolute;
		inset: 10px auto auto 10px;
		display: flex;
		gap: 8px;
		flex-wrap: wrap
	}

	.badge {
		background: #7c2d12;
		color: #fff;
		padding: 6px 10px;
		border-radius: 999px;
		font-size: 12px
	}

	.price {
		position: absolute;
		right: 10px;
		top: 10px;
		background: linear-gradient(135deg, #fb923c, #f59e0b);
		color: #0b1320;
		font-weight: 800;
		border-radius: 999px;
		padding: 6px 10px
	}

	.body {
		padding: 12px 12px 12px 12px;
		display: flex;
		flex-direction: column;
		gap: 6px
	}

	.title {
		font-size: 16px;
		margin: 0;
		font-weight: 700
	}

	.addr {
		color: #64748b;
		font-size: 13px
	}

	.specs {
		display: flex;
		gap: 10px;
		flex-wrap: wrap;
		color: #7c2d12;
		font-size: 13px
	}

	.specs span {
		background: var(--chip);
		border: 1px solid #fed7aa;
		padding: 6px 8px;
		border-radius: 999px
	}

	.empty {
		background: var(--card);
		border: 1px dashed var(--border);
		border-radius: 14px;
		padding: 18px;
		text-align: center;
		color: #c4661a
	}

	.modal {
		position: fixed;
		inset: 0;
		background: rgba(0, 0, 0, .35);
		display: none;
		align-items: center;
		justify-content: center;
		z-index: 50
	}

	.modal.open {
		display: flex
	}

	.modal-card {
		width: 96vw;
		max-width: 1050px;
		max-height: 94vh;
		background: #fff;
		border-radius: 18px;
		overflow: hidden;
		border: 1px solid var(--border);
		box-shadow: var(--shadow);
		display: grid;
		grid-template-columns: .8fr 1.2fr
	}

	@media(max-width:980px) {
		.modal-card {
			grid-template-columns: 1fr
		}
	}

	.modal-left {
		padding: 14px;
		display: flex;
		flex-direction: column;
		gap: 10px;
		background: #fffdf9
	}

	.modal-right {
		padding: 14px;
		overflow: auto
	}

	.modal-head {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 6px
	}

	.modal-title {
		font-weight: 800;
		font-size: 18px;
		margin: 0
	}

	.close {
		background: #fff;
		border: 1px solid var(--border);
		border-radius: 8px;
		padding: 6px 10px;
		cursor: pointer
	}

	.photoBar {
		display: flex;
		gap: 10px;
		flex-wrap: wrap
	}

	.thumb {
		position: relative;
		width: 128px;
		height: 96px;
		border-radius: 10px;
		overflow: hidden;
		border: 1px solid var(--border);
		background: #fff7ed
	}

	.thumb img {
		width: 100%;
		height: 100%;
		object-fit: cover
	}

	.thumb button {
		position: absolute;
		top: 6px;
		right: 6px;
		background: rgba(0, 0, 0, .55);
		color: #fff;
		border: none;
		border-radius: 8px;
		font-size: 12px;
		padding: 4px 6px;
		cursor: pointer
	}

	.addPhoto {
		display: inline-block;
		background: #fff;
		border: 1px dashed #fbd6a8;
		color: #0b1320;
		padding: 10px 12px;
		border-radius: 10px;
		cursor: pointer
	}

	label {
		display: block;
		font-size: 12px;
		color: var(--muted);
		margin: 8px 0 6px
	}

	input[type=text],
	input[type=number],
	select,
	textarea {
		width: 230px;
		background: #fff;
		border: 1px solid var(--border);
		color: #0b1320;
		border-radius: 10px;
		padding: 10px 12px;
		font-size: 14px;
		outline: none
	}

	textarea {
		min-height: 90px;
		resize: vertical
	}

	.form-grid {
		display: grid;
		grid-template-columns: repeat(6, 1fr);
		gap: 10px
	}

	.form-grid .col-6 {
		grid-column: span 6
	}

	.form-grid .col-3 {
		grid-column: span 3
	}

	.form-grid .col-2 {
		grid-column: span 2
	}

	@media(max-width:900px) {
		.form-grid {
			grid-template-columns: 1fr
		}

		.form-grid .col-6,
		.form-grid .col-3,
		.form-grid .col-2 {
			grid-column: 1/span 1
		}
	}

	.priceWrap {
		display: flex;
		gap: 8px
	}

	.priceWrap input {
		flex: 1
	}

	.priceWrap .cur {
		width: 80px !important;
	}

	.modal-actions {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-top: 10px;
		margin-bottom: 10px
	}

	.leftActions {
		display: flex;
		gap: 10px
	}

	.btn-danger {
		background: #ef4444;
		color: #fff;
		border: none;
		border-radius: 10px;
		padding: 10px 14px;
		font-weight: 700;
		cursor: pointer
	}

	.btn-secondary {
		background: #fff;
		border: 1px solid var(--border);
		color: #0b1320;
		border-radius: 10px;
		padding: 10px 14px;
		cursor: pointer
	}

	.small {
		font-size: 12px;
		color: #64748b
	}
	.smaller {
		font-size: 12px;
		color: #64748b;
		align-self: flex-end;
	}
	.mainstatus {
		margin-left: 100px;
    	position: relative;
    	top: -38px;
	}

	#application {
		display: none;
	}
	#logout {
		cursor: pointer;
	}
	#editModal input[type=text],
	#editModal input[type=number],
	#editModal select,
	#editModal textarea {
		width: 100%;
	}
    .container #status {
		position: absolute;
	    z-index: 999;
	    margin-top: -20px;
	    font-weight: 600;
	    margin-left: 12px;
	}
	</style>
</head>

<body>
	<div class="container">
		<div class="header">
			<div class="brand">
				<div class="logo"></div>
				<h1>Komplex<span style="font-weight:300">Ingatlan</span>.com</h1>
			</div>
			<div style="display:flex;gap:8px">
				<a class="link" href="index.html">Nyilvános oldal</a>
				<a class="cta" href="manage.html">Kezelés</a>
				<a class="link" href="new.html">Új ingatlan</a>
				<a id="logout" type="button">Log off</a>
			</div>
		</div>
		<div id="pass" style="
		    position: absolute;
		    top: 50%;
		    left: 50%;
		    transform: translate(-50%, -50%);
		    filter: drop-shadow(2px 4px 6px #ddd);
		">
			<span style="
		    position: absolute;
		    margin: -25px 5px;
		    font-weight: 600;
		">Bejelentkezés</span>
			<input id="password" type="password" autocomplete="off" style="
			font-size: 25px;
		    padding: 5px 10px 8px 10px;
		    border: 1px solid #eee;
		    width: 240px;
		    text-align: center;
		    border-radius: 8px;
		">
		</div>
		<div id="tool" class="toolbar">
			<input id="q" class="search" placeholder="Keresés cím, város, megye szerint">
			<select id="filterType">
				<option value="">Összes típus</option>
				<option>Családi ház</option>
				<option>Lakás</option>
				<option>Nyaraló</option>
				<option>Telek</option>
				<option>Ipari ingatlan</option>
			</select>
			<select id="sortBy">
				<option value="date_desc">Legújabb</option>
				<option value="date_asc">Legrégebbi</option>
				<option value="price_asc">Ár ↑</option>
				<option value="price_desc">Ár ↓</option>
			</select>
			<button class="btn" id="refreshBtn">Frissítés</button>
		</div>
		<div id="status" class="status mainstatus"></div>
		<div id="grid" class="grid"></div>
	</div>
	<div id="editModal" class="modal">
		<div class="modal-card">
			<div class="modal-left">
				<div class="modal-head">
					<h3 class="modal-title">Fényképek</h3>
				</div>
				<div class="photoBar" id="mPhotoBar"></div>
				<label class="addPhoto">Képek hozzáadása<input id="mAddPhotos" type="file" accept="image/*" multiple style="display:none"></label>
				<div class="small" id="mPhotoHint">Legfeljebb 10 kép • max. ~5MB/kép</div>
			</div>
			<div class="modal-right">
				<div class="modal-head">
					<h3 class="modal-title">Ingatlan szerkesztése</h3>
					<button class="close" id="closeModalRight">Bezárás</button>
				</div>
				<div class="form-grid">
					<div class="col-3">
						<label for="mId">Azonosító</label>
						<input id="mId" type="text" readonly>
					</div>
					<div class="col-6">
						<label for="mTitle">Főcím</label>
						<input id="mTitle" type="text">
					</div>
					<div class="col-3">
						<label for="mPrice">Ár</label>
						<div class="priceWrap">
							<input id="mPrice" type="number" min="0" step="1">
							<select id="mCurrency" class="cur">
								<option value="HUF">HUF</option>
								<option value="EUR">EUR</option>
							</select>
						</div>
					</div>
					<div class="col-3">
						<label for="mType">Ingatlan típusa</label>
						<select id="mType">
							<option value="">Válasszon</option>	
							<option>Családi ház</option>
							<option>Lakás</option>
							<option>Nyaraló</option>
							<option>Telek</option>
							<option>Ipari ingatlan</option>
						</select>
					</div>
					<div class="col-2">
						<label for="mBeds">Hálószobák</label>
						<input id="mBeds" type="number" min="0" step="1">
					</div>
					<div class="col-2">
						<label for="mBaths">Fürdőszobák</label>
						<input id="mBaths" type="number" min="0" step="0.5">
					</div>
					<div class="col-2">
						<label for="mAreaM2">Alapterület (m²)</label>
						<input id="mAreaM2" type="number" min="0" step="1">
					</div>
					<div class="col-6">
						<label for="mAddress">Cím</label>
						<input id="mAddress" type="text">
					</div>
					<div class="col-3">
						<label for="mCity">Város</label>
						<input id="mCity" type="text">
					</div>
					<div class="col-3">
						<label for="mState">Megye/Ország</label>
						<input id="mState" type="text">
					</div>
					<div class="col-6">
						<label for="mDesc">Leírás</label>
						<textarea id="mDesc"></textarea>
					</div>
				</div>
				<div class="modal-actions">
					<div class="leftActions">
						<button class="btn-danger" id="mDelete">Törlés</button>
						<button class="btn-secondary" id="mCancel">Mégse</button>
					</div>
					<div>
						<span id="mStatus" class="status"></span>
						<button class="btn" id="mSave">Mentés</button>
					</div>
				</div>
				<div class="small" id="mMeta"></div>
			</div>
		</div>
	</div>	
	<script src="config.js"></script>
	<script src="APIconfig.js"></script>
	<script>
	document.addEventListener('DOMContentLoaded', () => {
		const SECRET = window.PUBLIC_PASS?.pass;
		const input = document.getElementById('password');
		const passContainer = document.getElementById('pass');
		let restt = document.getElementById('grid');
		let restt2 = document.getElementById('tool');
		const logoutBtn = document.getElementById('logout');
		const placeholder = document.createComment('application-placeholder');
		const placeholderL = document.createComment('application-placeholder');
		const placeholder2 = document.createComment('application-placeholder');
		if(restt && restt.parentNode) {
			restt.parentNode.replaceChild(placeholder, restt);
			restt2.parentNode.replaceChild(placeholder2, restt2);
			logoutBtn.parentNode.replaceChild(placeholderL, logoutBtn);
		}
		const loadStored = () => {
			const saved = localStorage.getItem('password') || '';
			if(saved) input.value = saved;
		};
		const authorized = () => input.value.includes(SECRET);

		function show() {
			if(!restt.isConnected && placeholder.parentNode) {
				placeholder.parentNode.insertBefore(restt, placeholder.nextSibling);
				placeholder2.parentNode.insertBefore(restt2, placeholder2.nextSibling);
				placeholderL.parentNode.insertBefore(logoutBtn, placeholderL.nextSibling);
			}
			restt.style.setProperty('display', 'grid', 'important');
			restt2.style.setProperty('display', 'flex', 'important');
			logoutBtn.style.setProperty('display', 'inline-grid', 'important');
			input.disabled = true;
			passContainer.style.setProperty('display', 'none', 'important');
		}

		function hide() {
			if(restt.isConnected && restt.parentNode) {
				restt.parentNode.replaceChild(placeholder, restt);
				restt2.parentNode.replaceChild(placeholder2, restt2);
				logoutBtn.parentNode.replaceChild(placeholderL, logoutBtn);
			}
			restt.style.setProperty('display', 'none', 'important');
			restt2.style.setProperty('display', 'none', 'important');
			logoutBtn.style.setProperty('display', 'none', 'important');
			input.disabled = false;
			passContainer.style.removeProperty('display');
		}

		function sync() {
			if(authorized()) {
				localStorage.setItem('password', input.value);
				show();
			} else {
				hide();
			}
		}
		input.addEventListener('input', sync);
		input.addEventListener('change', sync);
		logoutBtn.addEventListener('click', () => {
			localStorage.removeItem('password');
			input.value = '';
			hide();
		});
		const mo = new MutationObserver(() => {
			if(!authorized()) {
				const el = document.getElementById('grid');
				const el2 = document.getElementById('logoutBtn');
				const el3 = document.getElementById('tool');
				if(el && el.isConnected) {
					el.parentNode.replaceChild(placeholder, el);
					el2.parentNode.replaceChild(placeholderL, el2);
					el3.parentNode.replaceChild(placeholder2, el3);
				}
			}
		});
		mo.observe(document.documentElement, {
			subtree: true,
			childList: true,
			attributes: true,
			attributeFilter: ['style', 'class', 'hidden']
		});
		loadStored();
		sync();
	});

const GH_OWNER = 'sebastianslusnik';
const GH_REPO = 'real';
const GH_WORKFLOW_FILE = 'pages.yml'; // .github/workflows/pages.yml
const GH_REF = 'main';
const GH_TOKEN = window.PUBLIC_CONFIG?.apiBase; // or hardcode to test, then rotate

async function triggerPagesBuild() {
if (!GH_TOKEN) throw new Error('GH_TOKEN is missing (PAT).');
const url = `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/actions/workflows/${encodeURIComponent(GH_WORKFLOW_FILE)}/dispatches`;
const res = await fetch(url, {
method: 'POST',
headers: {
'Authorization': `Bearer ${GH_TOKEN}`,
'Accept': 'application/vnd.github+json',
'Content-Type': 'application/json',
'X-GitHub-Api-Version': '2022-11-28'
},
body: JSON.stringify({ ref: GH_REF })
});
if (!res.ok) {
const text = await res.text().catch(() => '');
throw new Error(`GitHub workflow trigger failed: ${res.status} ${res.statusText} ${text}`);
}
}
let buildTriggerTimer = null;
function queueBuildTrigger() {
clearTimeout(buildTriggerTimer);
buildTriggerTimer = setTimeout(async () => {
try {
await triggerPagesBuild();
setStatus('Publikálás indítva – 1-2 perc és frissül a nyilvános oldal.', 'ok');
} catch (e) {
console.error(e);
setStatus('Publikálás indítása nem sikerült. Indítsa kézzel az Actions-ben.', 'err');
}
}, 800);
}

		
	const BIN_ID = '68add1c9ae596e708fd72498'
	const MASTER_KEY = '$2a$10$9sO/ja29sMebpWNvsWmp5.dJ6lv7CPeLBMRFaA/cAEwz42ii6qlCS'
	const BASE_URL = 'https://api.jsonbin.io/v3/b/' + BIN_ID
	const IMGBB_KEY = 'aedade0e0aed06accc870f38c2558577'
	const EUR_TO_HUF = 390
	const SQFT_PER_M2 = 10.7639
	const statusEl = document.getElementById('status')
	const grid = document.getElementById('grid')
	const q = document.getElementById('q')
	const filterType = document.getElementById('filterType')
	const sortBy = document.getElementById('sortBy')
	const refreshBtn = document.getElementById('refreshBtn')
	const modal = document.getElementById('editModal')
	const mPhotoBar = document.getElementById('mPhotoBar')
	const mAddPhotos = document.getElementById('mAddPhotos')
	const mTitle = document.getElementById('mTitle')
	const mPrice = document.getElementById('mPrice')
	const mCurrency = document.getElementById('mCurrency')
	const mType = document.getElementById('mType')
	const mBeds = document.getElementById('mBeds')
	const mBaths = document.getElementById('mBaths')
	const mAreaM2 = document.getElementById('mAreaM2')
	const mAddress = document.getElementById('mAddress')
	const mCity = document.getElementById('mCity')
	const mState = document.getElementById('mState')
	const mDesc = document.getElementById('mDesc')
	const mId = document.getElementById('mId')
	const mSave = document.getElementById('mSave')
	const mCancel = document.getElementById('mCancel')
	const mDelete = document.getElementById('mDelete')
	const mStatus = document.getElementById('mStatus')
	const mMeta = document.getElementById('mMeta')
	const closeModalRight = document.getElementById('closeModalRight')
	let listings = []
	let editIndex = -1
	let editPhotos = []

	function setStatus(msg, type) {
		statusEl.textContent = msg || '';
		statusEl.className = 'status ' + (type || '')
	}

	function setModalStatus(msg, type) {
		mStatus.textContent = msg || '';
		mStatus.className = 'status ' + (type || '')
	}

	function uid() {
		if(crypto.randomUUID) {
			return crypto.randomUUID()
		}
		return Date.now().toString(36) + Math.random().toString(36).slice(2)
	}

	function fmtMoneyEUR(e) {
		return new Intl.NumberFormat('hu-HU', {
			style: 'currency',
			currency: 'EUR',
			maximumFractionDigits: 0
		}).format(e)
	}

	function fmtMoneyHUF(h) {
		return new Intl.NumberFormat('hu-HU', {
			style: 'currency',
			currency: 'HUF',
			maximumFractionDigits: 0
		}).format(h)
	}

	function fmtDisplayPrice(item) {
		const c = item.currency || 'EUR';
		if(c === 'HUF') {
			const v = item.priceOriginal != null ? item.priceOriginal : Math.round((item.price || 0) * EUR_TO_HUF);
			return fmtMoneyHUF(v || 0)
		} else {
			const v = item.priceOriginal != null ? item.priceOriginal : (item.price || 0);
			return fmtMoneyEUR(v || 0)
		}
	}

	function normalize(x) {
		const y = {
			...x
		};
		const id = y.id || uid();
		const title = y.title || y.heading || 'Cím nélkül';
		const description = y.description || y.additionalDetails || '';
		let currency = y.currency || 'EUR';
		let priceEUR = typeof y.price === 'number' ? y.price : 0;
		let priceOriginal = typeof y.priceOriginal === 'number' ? y.priceOriginal : null;
		if(priceOriginal == null) {
			priceOriginal = currency === 'HUF' ? Math.round(priceEUR * EUR_TO_HUF) : priceEUR
		}
		const propertyType = y.propertyType || y.type || '';
		const photos = Array.isArray(y.photos) ? y.photos : [];
		const areaM2 = y.areaM2Original != null ? Number(y.areaM2Original) : Math.round(Number(y.area || 0) / SQFT_PER_M2);
		return {
			id,
			title,
			description,
			price: priceEUR,
			priceEUR,
			priceOriginal,
			currency,
			propertyType,
			bedrooms: Number(y.bedrooms || 0),
			bathrooms: Number(y.bathrooms || 0),
			areaM2Original: areaM2,
			area: Number(y.area || Math.round(areaM2 * SQFT_PER_M2)),
			address: y.address || '',
			city: y.city || '',
			state: y.state || '',
			photos,
			createdAt: y.createdAt || new Date().toISOString(),
			updatedAt: y.updatedAt || null
		}
	}
	async function fetchListings() {
		const res = await fetch(BASE_URL + '/latest', {
			headers: {
				'X-Master-Key': MASTER_KEY,
				'Content-Type': 'application/json'
			}
		});
		if(!res.ok) {
			if(res.status === 404) return [];
			throw new Error('Betöltési hiba')
		}
		const j = await res.json();
		return Array.isArray(j.record) ? j.record : []
	}
	async function saveListings(arr) {
		const res = await fetch(BASE_URL, {
		method: 'PUT',
		headers: {
		'X-Master-Key': MASTER_KEY,
		'Content-Type': 'application/json'
		},
		body: JSON.stringify(arr)
		});
		if (!res.ok) throw new Error('Mentési hiba');
	}

	function placeholderImg() {
		const svg = encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="600"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#fff3e5"/><stop offset="100%" stop-color="#ffe8cc"/></linearGradient></defs><rect width="100%" height="100%" fill="url(#g)"/><text x="50%" y="50%" fill="#7c2d12" font-size="24" font-family="Arial" text-anchor="middle" dominant-baseline="middle">Nincs fotó</text></svg>');
		return 'data:image/svg+xml;charset=utf-8,' + svg
	}

	function getFilteredSorted() {
		const term = q.value.trim().toLowerCase();
		const type = filterType.value;
		let arr = [...listings];
		if(term) {
			arr = arr.filter(it => (it.title + ' ' + it.city + ' ' + it.state + ' ' + (it.id || '')).toLowerCase().includes(term))
		}
		if(type) {
			arr = arr.filter(it => it.propertyType === type)
		}
		const s = sortBy.value;
		arr.sort((a, b) => {
			if(s === 'price_asc') return (a.price || 0) - (b.price || 0);
			if(s === 'price_desc') return (b.price || 0) - (a.price || 0);
			if(s === 'date_asc') return new Date(a.createdAt) - new Date(b.createdAt);
			return new Date(b.createdAt) - new Date(a.createdAt)
		});
		return arr
	}

	function render() {
		grid.innerHTML = '';
		const arr = getFilteredSorted();
		if(!arr.length) {
			const d = document.createElement('div');
			d.className = 'empty';
			d.textContent = 'Nincs találat';
			grid.appendChild(d);
			return
		}
		arr.forEach(item => {
			const card = document.createElement('div');
			card.className = 'card';
			card.dataset.id = item.id;
			const media = document.createElement('div');
			media.className = 'media';
			const img = document.createElement('img');
			img.src = item.photos && item.photos[0] ? item.photos[0] : placeholderImg();
			media.appendChild(img);
			const badges = document.createElement('div');
			badges.className = 'badges';
			const b1 = document.createElement('div');
			b1.className = 'badge';
			b1.textContent = item.propertyType || '—';
			badges.appendChild(b1);
			media.appendChild(badges);
			const price = document.createElement('div');
			price.className = 'price';
			price.textContent = fmtDisplayPrice(item);
			media.appendChild(price);
			const body = document.createElement('div');
			body.className = 'body';
			const title = document.createElement('h3');
			title.className = 'title';
			title.textContent = item.title;
			const addr = document.createElement('div');
			addr.className = 'addr';
			addr.textContent = [item.address, item.city, item.state].filter(Boolean).join(', ');
			const specs = document.createElement('div');
			specs.className = 'specs';
			const s1 = document.createElement('span');
			s1.textContent = (item.bedrooms || 0) + ' háló';
			const s2 = document.createElement('span');
			s2.textContent = (item.bathrooms || 0) + ' fürdő';
			const s3 = document.createElement('span');
			s3.textContent = (item.areaM2Original || 0) + ' m²';
			specs.appendChild(s1);
			specs.appendChild(s2);
			specs.appendChild(s3);
			body.appendChild(title);
			body.appendChild(addr);
			body.appendChild(specs);
			const idLine = document.createElement('div');
			idLine.className = 'smaller';
			idLine.textContent = 'ID: ' + (item.id || '');
			body.appendChild(idLine);
			card.appendChild(media);
			card.appendChild(body);
			card.addEventListener('click', () => openEditor(item.id));
			grid.appendChild(card)
		})
	}

	function openEditor(id) {
		editIndex = listings.findIndex(x => x.id === id);
		if(editIndex < 0) return;
		const it = listings[editIndex];
		editPhotos = [...(it.photos || [])];
		mTitle.value = it.title || '';
		mCurrency.value = it.currency || 'EUR';
		mPrice.value = it.currency === 'HUF' ? (it.priceOriginal || Math.round((it.price || 0) * EUR_TO_HUF)) : (it.priceOriginal || it.price || 0);
		mType.value = it.propertyType || '';
		mBeds.value = it.bedrooms || 0;
		mBaths.value = it.bathrooms || 0;
		mAreaM2.value = it.areaM2Original || Math.round((it.area || 0) / SQFT_PER_M2);
		mAddress.value = it.address || '';
		mCity.value = it.city || '';
		mState.value = it.state || '';
		mDesc.value = it.description || '';
		mId.value = it.id || '';
		mMeta.textContent = 'Létrehozva: ' + new Date(it.createdAt).toLocaleString() + (it.updatedAt ? ' • Módosítva: ' + new Date(it.updatedAt).toLocaleString() : '');
		renderEditPhotos();
		mStatus.textContent = '';
		modal.classList.add('open');
		document.body.style.overflow = 'hidden'
	}

	function closeEditor() {
		modal.classList.remove('open');
		document.body.style.overflow = '';
		editIndex = -1
	}

	function renderEditPhotos() {
		mPhotoBar.innerHTML = '';
		editPhotos.forEach((url, idx) => {
			const th = document.createElement('div');
			th.className = 'thumb';
			const im = document.createElement('img');
			im.src = url;
			const rm = document.createElement('button');
			rm.textContent = 'Eltávolítás';
			rm.onclick = () => {
				editPhotos.splice(idx, 1);
				renderEditPhotos()
			};
			th.appendChild(im);
			th.appendChild(rm);
			mPhotoBar.appendChild(th)
		})
	}

	function fileToPreview(file) {
		return new Promise((res, rej) => {
			const r = new FileReader();
			r.onload = () => res(r.result);
			r.onerror = rej;
			r.readAsDataURL(file)
		})
	}
	async function compressImage(file, max = 1600, quality = .86) {
		const dataUrl = await fileToPreview(file);
		const img = new Image();
		img.decoding = 'async';
		img.src = dataUrl;
		await img.decode();
		const scale = Math.min(1, max / Math.max(img.width, img.height));
		const canvas = document.createElement('canvas');
		canvas.width = Math.round(img.width * scale);
		canvas.height = Math.round(img.height * scale);
		const ctx = canvas.getContext('2d');
		ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
		const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', quality));
		return new File([blob], (file.name || 'photo') + '.jpg', {
			type: 'image/jpeg'
		})
	}
	async function uploadImage(file) {
		const base64 = await new Promise((res, rej) => {
			const r = new FileReader();
			r.onload = () => res(String(r.result).split(',')[1]);
			r.onerror = rej;
			r.readAsDataURL(file)
		});
		const fd = new FormData();
		fd.append('image', base64);
		const r = await fetch('https://api.imgbb.com/1/upload?key=' + encodeURIComponent(IMGBB_KEY), {
			method: 'POST',
			body: fd
		});
		const j = await r.json();
		if(!r.ok || !j || !j.data || !j.data.display_url) throw new Error('Feltöltés sikertelen');
		return j.data.display_url
	}
	mAddPhotos.addEventListener('change', async e => {
		if(editIndex < 0) return;
		const files = [...e.target.files].slice(0, 10 - editPhotos.length);
		if(!files.length) return;
		setModalStatus('Fotók feltöltése...');
		try {
			for(const file of files) {
				const small = await compressImage(file);
				const url = await uploadImage(small);
				if(editPhotos.length < 10) editPhotos.push(url)
			}
			renderEditPhotos();
			setModalStatus('Fotók feltöltve', 'ok')
		} catch (err) {
			setModalStatus('Fotó feltöltése sikertelen', 'err')
		}
		e.target.value = ''
	})
	mSave.addEventListener('click', async () => {
		if(editIndex < 0) return;
		const priceInput = Number(mPrice.value || 0);
		const currency = mCurrency.value;
		const priceEUR = currency === 'EUR' ? priceInput : priceInput / EUR_TO_HUF;
		const areaM2 = Number(mAreaM2.value || 0);
		const areaSqft = Math.round(areaM2 * SQFT_PER_M2);
		const updated = {
			...listings[editIndex],
			title: mTitle.value.trim(),
			price: priceEUR,
			priceEUR,
			priceOriginal: priceInput,
			currency,
			propertyType: mType.value,
			bedrooms: Number(mBeds.value || 0),
			bathrooms: Number(mBaths.value || 0),
			area: areaSqft,
			areaM2Original: areaM2,
			address: mAddress.value.trim(),
			city: mCity.value.trim(),
			state: mState.value.trim(),
			description: mDesc.value.trim(),
			photos: [...editPhotos],
			updatedAt: new Date().toISOString()
		};
		setModalStatus('Mentés...');
		try {
			const all = await fetchListings();
			const norm = all.map(normalize);
			const idx = norm.findIndex(x => x.id === updated.id);
			if (idx > -1) {
			norm[idx] = updated;
			} else {
			norm.push(updated);
			}
			await saveListings(norm);
			listings = norm;
			setModalStatus('Mentve', 'ok');
			render();
			
			// Trigger Pages rebuild
			queueBuildTrigger();
			
			setTimeout(closeEditor, 300);
		} catch (e) {
			setModalStatus('Hiba mentés közben', 'err')
		}
	})
	mDelete.addEventListener('click', async () => {
		if(editIndex < 0) return;
		if(!confirm('Biztosan törli ezt az ingatlant?')) return;
		setModalStatus('Törlés...');
		try {
			const all = await fetchListings();
			const norm = all.map(normalize).filter(x => x.id !== listings[editIndex].id);
			await saveListings(norm);
			listings = norm;
			setModalStatus('Törölve', 'ok');
			render();
			
			// Trigger Pages rebuild
			queueBuildTrigger();
			
			setTimeout(closeEditor, 300);
		} catch (e) {
			setModalStatus('Hiba törlés közben', 'err')
		}
	})
	mCancel.addEventListener('click', closeEditor)
	closeModalRight.addEventListener('click', closeEditor)
	document.addEventListener('keydown', e => {
		if(e.key === 'Escape' && modal.classList.contains('open')) closeEditor()
	})
	modal.addEventListener('click', e => {
		if(e.target === modal) closeEditor()
	})
	async function init() {
		setStatus('Betöltés...');
		try {
			const raw = await fetchListings();
			listings = raw.map(normalize);
			setStatus('');
			render()
		} catch (e) {
			setStatus('Hiba betöltés közben', 'err')
		}
	}

	function refresh() {
		init()
	}

	function onFilterChange() {
		render()
	}
	[q, filterType, sortBy].forEach(el => el.addEventListener('input', onFilterChange))
	refreshBtn.addEventListener('click', refresh)
	init()
	</script>
</body>

</html>


















