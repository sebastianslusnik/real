name: Build and deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *' # every 6 hours; adjust as needed

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'pages'
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Fetch data from JSONBin
        run: node scripts/fetch-jsonbin.js
        env:
          BIN_ID: ${{ secrets.JSONBIN_BIN_ID }}
          JSONBIN_MASTER_KEY: ${{ secrets.JSONBIN_MASTER_KEY }}

      - name: Prepare Pages artifact
        run: |
          mkdir -p dist
          cp -R ./*.html dist/
          cp -R ./data dist/
          # Copy any other static assets you reference:
          # images, icons, CSS, JS, etc.
          # Example:
          [ -f ./favii.png ] && cp ./favii.png dist/ || true

      - name: Inject public config
        env:
          PUBLIC_API_BASE: ${{ vars.PUBLIC_API_BASE }}
          PUBLIC_FEATURE_FLAG: ${{ vars.PUBLIC_FEATURE_FLAG }}
        run: |
          node -e "const fs=require('fs'); const cfg={ apiBase: process.env.PUBLIC_API_BASE || '', featureFlag: process.env.PUBLIC_FEATURE_FLAG || '' }; fs.writeFileSync('dist/APIconfig.js', 'window.PUBLIC_CONFIG = ' + JSON.stringify(cfg) + ';\n');"
      
      - name: Inject public pass
        env:
          PASSWORD: ${{ vars.PASSWORD }}
        run: |
          node -e "const fs=require('fs'); const cfg={ pass: process.env.PASSWORD || '' }; fs.writeFileSync('dist/config.js', 'window.PUBLIC_PASS = ' + JSON.stringify(cfg) + ';\n');"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
