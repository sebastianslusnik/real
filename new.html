<!doctype html>
<html lang="hu">

<head>
	<meta charset="utf-8">
	<title>KomplexIngatlan • Új ingatlan</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="icon" type="image/png" href="favii.png" />
	<style>
	:root {
		--bg: #fdfaf6;
		--card: #ffffff;
		--muted: #667085;
		--text: #0b1320;
		--primary: #fa943f;
		--primary-600: #ea580c;
		--border: #efe7dc;
		--chip: #fff7ed;
		--ok: #16a34a;
		--err: #dc2626;
		--shadow: 0 12px 28px rgba(16, 24, 40, .08)
	}

	* {
		box-sizing: border-box;
		font-family: 'Inter' !important;
	}

	body {
		margin: 0;
		background: var(--bg);
		color: var(--text);
		font-family: Inter
	}

	a {
		text-decoration: none;
		color: inherit
	}

	.container {
		max-width: 1100px;
		margin: 0 auto;
		padding: 28px 24px
	}

	.header {
		display: flex;
		align-items: center;
		justify-content: space-between;
		margin-bottom: 30px
	}

	.brand {
		display: flex;
		gap: 10px;
		align-items: center
	}

	.logo {
		width: 48px;
		height: 48px;
		border-radius: 50%;
		background-image: url(favii.png);
		background-position: center;
		background-repeat: no-repeat;
		background-size: contain;
	}

	.brand h1 {
		font-size: 18px;
		margin: 0;
		font-weight: 800
	}

	.header a {
		color: #1f2937;
		background: #fff;
		border: 1px solid var(--border);
		padding: 10px 16px;
		border-radius: 8px;
		font-weight: 600;
		font-size: 14px;
	}

	.header a.cta {
		background: var(--primary);
		color: #fff;
		border: none
	}

	.grid {
		display: grid;
		grid-template-columns: 1.2fr .8fr;
		gap: 18px
	}

	@media(max-width:900px) {
		.grid {
			grid-template-columns: 1fr
		}
	}

	.card {
		background: var(--card);
		border: 1px solid var(--border);
		border-radius: 14px;
		padding: 16px;
		box-shadow: var(--shadow)
	}

	.card h2 {
		margin: 0 0 12px;
		font-size: 18px
	}

	.row {
		display: grid;
		grid-template-columns: repeat(6, 1fr);
		gap: 12px
	}

	.row .col-6 {
		grid-column: span 6
	}

	.row .col-3 {
		grid-column: span 3
	}

	.row .col-2 {
		grid-column: span 2
	}

	@media(max-width:900px) {
		.row {
			grid-template-columns: 1fr
		}

		.row .col-6,
		.row .col-3,
		.row .col-2 {
			grid-column: 1/span 1
		}
	}

	label {
		display: block;
		font-size: 12px;
		color: var(--muted);
		margin: 8px 0 6px
	}

	input,
	select,
	textarea {
		width: 100%;
		background: #fff;
		border: 1px solid var(--border);
		color: #0b1320;
		border-radius: 10px;
		padding: 10px 12px;
		font-size: 14px;
		outline: none
	}

	select {
		min-width: 80px;
	}

	textarea {
		min-height: 120px;
		resize: vertical
	}

	.priceWrap {
		display: flex;
		gap: 8px
	}

	.priceWrap input {
		flex: 1
	}

	.priceWrap .cur {
		width: 80px
	}

	.actions {
		display: flex;
		gap: 10px;
		align-items: center;
		margin-top: 14px
	}

	.btn {
		background: var(--primary);
		color: #fff;
		border: none;
		border-radius: 8px;
		padding: 10px 14px;
		font-weight: 700;
		cursor: pointer
	}

	.btn:disabled {
		opacity: .6;
		cursor: not-allowed
	}

	.link {
		background: #fff;
		border: 1px solid var(--border);
		border-radius: 10px;
		padding: 10px 12px;
		color: #1f2937
	}

	.status {
		font-size: 13px;
		color: var(--muted)
	}

	.status.ok {
		color: var(--ok)
	}

	.status.err {
		color: var(--err)
	}

	.uploader {
		border: 1px dashed #fbd6a8;
		background: #fff;
		border-radius: 14px;
		padding: 14px;
		text-align: center
	}

	.uploader input {
		display: none
	}

	.uploader .hint {
		color: var(--muted);
		font-size: 13px
	}

	.uploader .btn-mini {
		margin-top: 8px;
		display: inline-block;
		background: #fff;
		border: 1px solid var(--border);
		padding: 8px 10px;
		border-radius: 10px;
		color: #0b1320
	}

	.previews {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
		gap: 10px;
		margin-top: 12px
	}

	.preview {
		position: relative;
		border-radius: 12px;
		overflow: hidden;
		border: 1px solid var(--border);
		background: #fff7ed
	}

	.preview img {
		width: 100%;
		height: 100px;
		object-fit: cover;
		display: block
	}

	.preview .rm {
		position: absolute;
		top: 6px;
		right: 6px;
		background: rgba(0, 0, 0, .55);
		color: #fff;
		border: none;
		border-radius: 10px;
		font-size: 12px;
		padding: 4px 8px;
		cursor: pointer
	}

	.meta {
		display: flex;
		justify-content: space-between;
		align-items: center;
		color: var(--muted);
		font-size: 12px;
		margin-top: 6px
	}

	#application {
		display: none;
	}
	#logout {
		cursor: pointer;
	}
	</style>
</head>

<body>
	<div class="container">
		<div class="header">
			<div class="brand">
				<div class="logo"></div>
				<h1>Komplex<span style="font-weight:300">Ingatlan</span>.com</h1>
			</div>
			<div style="display:flex;gap:8px">
				<a class="link" href="index.html">Nyilvános oldal</a>
				<a class="link" href="manage.html">Kezelés</a>
				<a class="cta" href="new.html">Új ingatlan</a>
				<a id="logout" type="button">Log off</a>
			</div>
		</div>
		<div id="pass" style="
		    position: absolute;
		    top: 50%;
		    left: 50%;
		    transform: translate(-50%, -50%);
		    filter: drop-shadow(2px 4px 6px #ddd);
		">
			<span style="
		    position: absolute;
		    margin: -25px 5px;
		    font-weight: 600;
		">Bejelentkezés</span>
			<input id="password" type="password" autocomplete="off" style="
			font-size: 25px;
		    padding: 5px 10px 8px 10px;
		    border: 1px solid #eee;
		    width: 240px;
		    text-align: center;
		    border-radius: 8px;
		">
		</div>
		<div id="application" class="grid">
			<div class="card">
				<h2>Ingatlan adatai</h2>
				<div class="row">
					<div class="col-6">
						<label for="title">Főcím</label>
						<input id="title" placeholder="Modern 3 hálószobás otthon">
					</div>
					<div class="col-3">
						<label for="price">Ár</label>
						<div class="priceWrap">
							<input id="price" type="number" min="0" step="1" placeholder="350000">
							<select id="currency" class="cur">
								<option value="HUF">HUF</option>
								<option value="EUR">EUR</option>
							</select>
						</div>
					</div>
					<div class="col-3">
						<label for="type">Ingatlan típusa</label>
						<select id="type">
							<option value="">Válasszon típust</option>							
							<option>Családi ház</option>
							<option>Lakás</option>
							<option>Nyaraló</option>
							<option>Telek</option>
							<option>Ipari ingatlan</option>
						</select>
					</div>
					<div class="col-2">
						<label for="beds">Hálószobák</label>
						<input id="beds" type="number" min="0" step="1" placeholder="3">
					</div>
					<div class="col-2">
						<label for="baths">Fürdőszobák</label>
						<input id="baths" type="number" min="0" step="0.5" placeholder="2">
					</div>
					<div class="col-2">
						<label for="areaM2">Alapterület (m²)</label>
						<input id="areaM2" type="number" min="0" step="1" placeholder="120">
					</div>
					<div class="col-6">
						<label for="address">Cím</label>
						<input id="address" placeholder="Magyar utca 1.">
					</div>
					<div class="col-3">
						<label for="city">Város</label>
						<input id="city" placeholder="Mosonmagyaróvár">
					</div>
					<div class="col-3">
						<label for="state">Megye/Ország</label>
						<input id="state" placeholder="Győr-Moson-Sopron, Magyarország">
					</div>
					<div class="col-6">
						<label for="desc">Leírás</label>
						<textarea id="desc" placeholder="Rövid leírás az ingatlanról"></textarea>
					</div>
				</div>
				<div class="actions">
					<button id="saveBtn" class="btn">Mentés</button>
					<span id="status" class="status"></span>
				</div>
			</div>
			<div class="card">
				<h2>Fotók</h2>
				<div class="uploader" id="drop">
					<div class="hint">Húzza ide a képeket, vagy</div>
					<label class="btn-mini" for="photos">Keresés</label>
					<input id="photos" type="file" accept="image/*" multiple>
					<div class="meta"><span id="photoCount">0 kiválasztva</span><span>Legfeljebb 10 kép • max. ~5MB/kép</span></div>
				</div>
				<div class="previews" id="previews"></div>
			</div>
		</div>
	</div>
	<script src="config.js"></script>
	<script src="APIconfig.js"></script>
	<script>
	document.addEventListener('DOMContentLoaded', () => {
		const SECRET = window.PUBLIC_PASS?.pass;
		const input = document.getElementById('password');
		const passContainer = document.getElementById('pass');
		let restt = document.getElementById('application');
		const logoutBtn = document.getElementById('logout');
		const placeholder = document.createComment('application-placeholder');
		const placeholderL = document.createComment('application-placeholder');
		if(restt && restt.parentNode) {
			restt.parentNode.replaceChild(placeholder, restt);
			logoutBtn.parentNode.replaceChild(placeholderL, logoutBtn);
		}
		const loadStored = () => {
			const saved = localStorage.getItem('password') || '';
			if(saved) input.value = saved;
		};
		const authorized = () => input.value.includes(SECRET);

		function show() {
			if(!restt.isConnected && placeholder.parentNode) {
				placeholder.parentNode.insertBefore(restt, placeholder.nextSibling);
				placeholderL.parentNode.insertBefore(logoutBtn, placeholderL.nextSibling);
			}
			restt.style.setProperty('display', 'inline-grid', 'important');
			logoutBtn.style.setProperty('display', 'inline-grid', 'important');
			input.disabled = true;
			passContainer.style.setProperty('display', 'none', 'important');
		}

		function hide() {
			if(restt.isConnected && restt.parentNode) {
				restt.parentNode.replaceChild(placeholder, restt);
				logoutBtn.parentNode.replaceChild(placeholderL, logoutBtn);
			}
			restt.style.setProperty('display', 'none', 'important');
			logoutBtn.style.setProperty('display', 'none', 'important');
			input.disabled = false;
			passContainer.style.removeProperty('display');
		}

		function sync() {
			if(authorized()) {
				localStorage.setItem('password', input.value);
				show();
			} else {
				hide();
			}
		}
		input.addEventListener('input', sync);
		input.addEventListener('change', sync);
		logoutBtn.addEventListener('click', () => {
			localStorage.removeItem('password');
			input.value = '';
			hide();
		});
		const mo = new MutationObserver(() => {
			if(!authorized()) {
				const el = document.getElementById('application');
				const el2 = document.getElementById('logoutBtn');
				if(el && el.isConnected) {
					el.parentNode.replaceChild(placeholder, el);
					el2.parentNode.replaceChild(placeholderL, el2);
				}
			}
		});
		mo.observe(document.documentElement, {
			subtree: true,
			childList: true,
			attributes: true,
			attributeFilter: ['style', 'class', 'hidden']
		});
		loadStored();
		sync();
	});
	const GH_OWNER = 'sebastianslusnik';
	const GH_REPO = 'real';
	const GH_WORKFLOW_FILE = 'pages.yml'; // .github/workflows/pages.yml
	const GH_REF = 'main'; // branch to build
	const GH_TOKEN = window.PUBLIC_CONFIG?.apiBase;
	async function triggerPagesBuild() {
		if(!GH_TOKEN) {
			throw new Error('GH_TOKEN is missing. Make sure config.js provides a PAT.');
		}
		const url = `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/actions/workflows/${encodeURIComponent(GH_WORKFLOW_FILE)}/dispatches`;
		const res = await fetch(url, {
			method: 'POST',
			headers: {
				'Authorization': `Bearer ${GH_TOKEN}`,
				'Accept': 'application/vnd.github+json',
				'Content-Type': 'application/json',
				'X-GitHub-Api-Version': '2022-11-28'
			},
			body: JSON.stringify({
				ref: 'main'
			})
		});
		if(!res.ok) {
			const text = await res.text().catch(() => '');
			throw new Error(`GitHub workflow trigger failed: ${res.status} ${res.statusText} ${text}`);
		}
	}
	const BIN_ID = '68add1c9ae596e708fd72498'
	const MASTER_KEY = '$2a$10$9sO/ja29sMebpWNvsWmp5.dJ6lv7CPeLBMRFaA/cAEwz42ii6qlCS'
	const BASE_URL = 'https://api.jsonbin.io/v3/b/' + BIN_ID
	const IMGBB_KEY = 'aedade0e0aed06accc870f38c2558577'
	const EUR_TO_HUF = 390
	const SQFT_PER_M2 = 10.7639
	const statusEl = document.getElementById('status')
	const saveBtn = document.getElementById('saveBtn')
	const drop = document.getElementById('drop')
	const inputPhotos = document.getElementById('photos')
	const previews = document.getElementById('previews')
	const photoCount = document.getElementById('photoCount')
	let queuedFiles = []

	function setStatus(msg, type) {
		statusEl.textContent = msg;
		statusEl.className = 'status ' + (type || '')
	}

	function uid() {
		if(crypto.randomUUID) {
			return crypto.randomUUID()
		}
		return Date.now().toString(36) + Math.random().toString(36).slice(2)
	}
	function random10Digits() {
if (window.crypto && crypto.getRandomValues) {
const arr = new Uint8Array(10);
crypto.getRandomValues(arr);
let s = '';
for (let i = 0; i < 10; i++) s += String(arr[i] % 10);
return s;
}
let s = '';
for (let i = 0; i < 10; i++) s += Math.floor(Math.random() * 10);
return s;
}
function generateUniqueNumericId(existingIds) {
const set = new Set((existingIds || []).map(String));
let id = random10Digits();
while (set.has(id)) id = random10Digits();
return id;
}

	function val(id) {
		return document.getElementById(id).value.trim()
	}

	function fileToPreview(file) {
		return new Promise((res, rej) => {
			const r = new FileReader();
			r.onload = () => res(r.result);
			r.onerror = rej;
			r.readAsDataURL(file)
		})
	}
	async function fileToBase64(file) {
		const data = await fileToPreview(file);
		return String(data).split(',')[1]
	}

	function renderPreviews() {
		previews.innerHTML = '';
		photoCount.textContent = queuedFiles.length + ' kiválasztva';
		queuedFiles.forEach((f, i) => {
			const wrap = document.createElement('div');
			wrap.className = 'preview';
			const img = document.createElement('img');
			img.src = f.preview;
			const rm = document.createElement('button');
			rm.className = 'rm';
			rm.textContent = 'Eltávolítás';
			rm.onclick = () => {
				queuedFiles.splice(i, 1);
				renderPreviews()
			};
			wrap.appendChild(img);
			wrap.appendChild(rm);
			previews.appendChild(wrap)
		})
	}

	function addFiles(files) {
		for(const f of files) {
			if(!f.type.startsWith('image/')) continue;
			if(queuedFiles.length >= 10) break;
			queuedFiles.push({
				file: f,
				preview: '',
				uploadedUrl: null
			})
		}
		Promise.all(queuedFiles.map(async q => {
			if(!q.preview) q.preview = await fileToPreview(q.file)
		})).then(renderPreviews)
	}
	drop.addEventListener('dragover', e => {
		e.preventDefault();
		drop.style.borderColor = '#f59e0b'
	});
	drop.addEventListener('dragleave', () => {
		drop.style.borderColor = 'var(--border)'
	});
	drop.addEventListener('drop', e => {
		e.preventDefault();
		drop.style.borderColor = 'var(--border)';
		addFiles(e.dataTransfer.files)
	})
	inputPhotos.addEventListener('change', e => addFiles(e.target.files))
	async function compressImage(file, max = 1600, quality = .86) {
		const dataUrl = await fileToPreview(file)
		const img = new Image();
		img.decoding = 'async';
		img.src = dataUrl;
		await img.decode()
		const scale = Math.min(1, max / Math.max(img.width, img.height))
		const canvas = document.createElement('canvas');
		canvas.width = Math.round(img.width * scale);
		canvas.height = Math.round(img.height * scale)
		const ctx = canvas.getContext('2d');
		ctx.drawImage(img, 0, 0, canvas.width, canvas.height)
		const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', quality))
		return new File([blob], (file.name || 'photo') + '.jpg', {
			type: 'image/jpeg'
		})
	}
	async function uploadImage(file) {
		if(!IMGBB_KEY) throw new Error('Adja meg az IMGBB API kulcsot')
		const base64 = await fileToBase64(file)
		const fd = new FormData()
		fd.append('image', base64)
		const r = await fetch('https://api.imgbb.com/1/upload?key=' + encodeURIComponent(IMGBB_KEY), {
			method: 'POST',
			body: fd
		})
		const j = await r.json()
		if(!r.ok || !j || !j.data || !j.data.display_url) throw new Error('Feltöltés sikertelen')
		return j.data.display_url
	}
	async function uploadPhotos() {
		const urls = []
		for(const q of queuedFiles) {
			if(q.uploadedUrl) {
				urls.push(q.uploadedUrl);
				continue
			}
			const small = await compressImage(q.file)
			const url = await uploadImage(small)
			q.uploadedUrl = url;
			urls.push(url)
		}
		return urls
	}
	async function fetchListings() {
		const res = await fetch(BASE_URL + '/latest', {
			headers: {
				'X-Master-Key': MASTER_KEY,
				'Content-Type': 'application/json'
			}
		})
		if(!res.ok) {
			if(res.status === 404) return [];
			throw new Error('Betöltési hiba')
		}
		const j = await res.json();
		return Array.isArray(j.record) ? j.record : []
	}
	async function saveListings(arr) {
		const res = await fetch(BASE_URL, {
			method: 'PUT',
			headers: {
				'X-Master-Key': MASTER_KEY,
				'Content-Type': 'application/json'
			},
			body: JSON.stringify(arr)
		})
		if(!res.ok) throw new Error('Mentési hiba')
	}
	saveBtn.addEventListener('click', async () => {
		const title = val('title'),
			priceStr = val('price'),
			currency = document.getElementById('currency').value,
			type = document.getElementById('type').value,
			beds = val('beds'),
			baths = val('baths'),
			areaM2Str = val('areaM2'),
			address = val('address'),
			city = val('city'),
			state = val('state'),
			desc = val('desc')
		if(!title || !priceStr || !currency || !type || !beds || !baths || !areaM2Str || !address || !city || !state) {
			setStatus('Kérjük, töltsön ki minden mezőt', 'err');
			return
		}
		const priceOriginal = Number(priceStr)
		const priceEUR = currency === 'EUR' ? priceOriginal : priceOriginal / EUR_TO_HUF
		const areaM2 = Number(areaM2Str)
		const areaSqft = Math.round(areaM2 * SQFT_PER_M2)
		saveBtn.disabled = true;
		setStatus('Fotók feltöltése...')
		try {
			const photos = await uploadPhotos()
			setStatus('Mentés folyamatban...')
			const list = await fetchListings()
			const item = {
				id: generateUniqueNumericId(list.map(x => x.id).filter(Boolean)),
				title,
				price: priceEUR,
				priceEUR,
				priceOriginal,
				currency,
				propertyType: type,
				bedrooms: Number(beds),
				bathrooms: Number(baths),
				area: areaSqft,
				areaM2Original: areaM2,
				address,
				city,
				state,
				description: desc,
				photos,
				createdAt: new Date().toISOString()
			}
			list.push(item)
			setStatus('Sikeres mentés', 'ok')
			document.getElementById('title').value = '';
			document.getElementById('price').value = '';
			document.getElementById('currency').value = 'HUF';
			document.getElementById('type').value = '';
			document.getElementById('beds').value = '';
			document.getElementById('baths').value = '';
			document.getElementById('areaM2').value = '';
			document.getElementById('address').value = '';
			document.getElementById('city').value = '';
			document.getElementById('state').value = '';
			document.getElementById('desc').value = ''
			queuedFiles = [];
			renderPreviews();
			photoCount.textContent = '0 kiválasztva';
			await saveListings(list)
			try {
				await triggerPagesBuild();
				setStatus('Sikeres mentés... 1-2 perc múlva megjelenik az oldalon.', 'ok');
			} catch (e) {
				console.error('Workflow trigger failed:', e);
				setStatus('A mentés SIKERES volt, de a publikálás indítása nem sikerült: ' + (e?.message || ''), 'err');
			}
		} catch (e) {
			setStatus('Hiba: ' + (e && e.message ? e.message : 'Nem sikerült menteni'), 'err')
		} finally {
			saveBtn.disabled = false
		}
	})
	</script>
</body>

</html>










