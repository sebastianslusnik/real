<!doctype html>
<html lang="hu">

<head>
	<meta charset="utf-8">
	<title>Realty • Új ingatlan felvitele</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<style>
	:root {
		--bg: #fdfaf6;
		--card: #ffffff;
		--muted: #667085;
		--text: #0b1320;
		--primary: #f97316;
		--primary-600: #ea580c;
		--border: #efe7dc;
		--chip: #fff7ed;
		--ok: #16a34a;
		--err: #dc2626;
		--shadow: 0 12px 28px rgba(16, 24, 40, .08)
	}

	* {
		box-sizing: border-box
	}

	body {
		margin: 0;
		background: var(--bg);
		color: var(--text);
		font-family: Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif
	}

	a {
		text-decoration: none;
		color: inherit
	}

	.container {
		max-width: 1100px;
		margin: 0 auto;
		padding: 28px 24px
	}

	.header {
		display: flex;
		align-items: center;
		justify-content: space-between;
		margin-bottom: 20px
	}

	.brand {
		display: flex;
		gap: 10px;
		align-items: center
	}

	.logo {
		width: 32px;
		height: 32px;
		border-radius: 8px;
		background: linear-gradient(135deg, #fb923c, #f59e0b)
	}

	.brand h1 {
		font-size: 18px;
		margin: 0
	}

	.header a {
		color: #1f2937;
		background: #fff;
		border: 1px solid var(--border);
		padding: 8px 12px;
		border-radius: 10px
	}

	.header a.cta {
		background: var(--primary);
		color: #fff;
		border: none
	}

	.grid {
		display: grid;
		grid-template-columns: 1.2fr .8fr;
		gap: 18px
	}

	@media(max-width:900px) {
		.grid {
			grid-template-columns: 1fr
		}
	}

	.card {
		background: var(--card);
		border: 1px solid var(--border);
		border-radius: 14px;
		padding: 16px;
		box-shadow: var(--shadow)
	}

	.card h2 {
		margin: 0 0 12px;
		font-size: 18px
	}

	.row {
		display: grid;
		grid-template-columns: repeat(6, 1fr);
		gap: 12px
	}

	.row .col-6 {
		grid-column: span 6
	}

	.row .col-3 {
		grid-column: span 3
	}

	.row .col-2 {
		grid-column: span 2
	}

	@media(max-width:900px) {
		.row {
			grid-template-columns: 1fr
		}

		.row .col-6,
		.row .col-3,
		.row .col-2 {
			grid-column: 1/span 1
		}
	}

	label {
		display: block;
		font-size: 12px;
		color: var(--muted);
		margin: 8px 0 6px
	}

	input,
	select,
	textarea {
		width: 100%;
		background: #fff;
		border: 1px solid var(--border);
		color: #0b1320;
		border-radius: 10px;
		padding: 10px 12px;
		font-size: 14px;
		outline: none
	}

	select {
		min-width: 80px;
	}

	textarea {
		min-height: 120px;
		resize: vertical
	}

	.priceWrap {
		display: flex;
		gap: 8px
	}

	.priceWrap input {
		flex: 1
	}

	.priceWrap .cur {
		width: 80px
	}

	.actions {
		display: flex;
		gap: 10px;
		align-items: center;
		margin-top: 14px
	}

	.btn {
		background: var(--primary);
		color: #fff;
		border: none;
		border-radius: 12px;
		padding: 10px 14px;
		font-weight: 700;
		cursor: pointer
	}

	.btn:disabled {
		opacity: .6;
		cursor: not-allowed
	}

	.link {
		background: #fff;
		border: 1px solid var(--border);
		border-radius: 10px;
		padding: 10px 12px;
		color: #1f2937
	}

	.status {
		font-size: 13px;
		color: var(--muted)
	}

	.status.ok {
		color: var(--ok)
	}

	.status.err {
		color: var(--err)
	}

	.uploader {
		border: 1px dashed #fbd6a8;
		background: #fff;
		border-radius: 14px;
		padding: 14px;
		text-align: center
	}

	.uploader input {
		display: none
	}

	.uploader .hint {
		color: var(--muted);
		font-size: 13px
	}

	.uploader .btn-mini {
		margin-top: 8px;
		display: inline-block;
		background: #fff;
		border: 1px solid var(--border);
		padding: 8px 10px;
		border-radius: 10px;
		color: #0b1320
	}

	.previews {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
		gap: 10px;
		margin-top: 12px
	}

	.preview {
		position: relative;
		border-radius: 12px;
		overflow: hidden;
		border: 1px solid var(--border);
		background: #fff7ed
	}

	.preview img {
		width: 100%;
		height: 100px;
		object-fit: cover;
		display: block
	}

	.preview .rm {
		position: absolute;
		top: 6px;
		right: 6px;
		background: rgba(0, 0, 0, .55);
		color: #fff;
		border: none;
		border-radius: 10px;
		font-size: 12px;
		padding: 4px 8px;
		cursor: pointer
	}

	.meta {
		display: flex;
		justify-content: space-between;
		align-items: center;
		color: var(--muted);
		font-size: 12px;
		margin-top: 6px
	}
	</style>
</head>

<body>
	<div class="container">
		<div class="header">
			<div class="brand">
				<div class="logo"></div>
				<h1>Realty Admin</h1>
			</div>
			<div style="display:flex;gap:8px">
				<a class="link" href="index.html">Nyilvános oldal</a>
				<a class="link" href="manage.html">Kezelés</a>
				<a class="cta" href="new.html">Új ingatlan</a>
			</div>
		</div>
		<div class="grid">
			<div class="card">
				<h2>Ingatlan adatai</h2>
				<div class="row">
					<div class="col-6">
						<label for="title">Cím</label>
						<input id="title" placeholder="Modern 3 hálószobás otthon">
					</div>
					<div class="col-3">
						<label for="price">Ár</label>
						<div class="priceWrap">
							<input id="price" type="number" min="0" step="1" placeholder="350000">
							<select id="currency" class="cur">
								<option value="HUF">HUF</option>
								<option value="EUR">EUR</option>
							</select>
						</div>
					</div>
					<div class="col-3">
						<label for="type">Ingatlan típusa</label>
						<select id="type">
							<option value="">Válasszon típust</option>
							<option>Családi ház</option>
							<option>Lakás</option>
							<option>Condo</option>
							<option>TownCsaládi ház</option>
							<option>Land</option>
						</select>
					</div>
					<div class="col-2">
						<label for="beds">Hálószobák</label>
						<input id="beds" type="number" min="0" step="1" placeholder="3">
					</div>
					<div class="col-2">
						<label for="baths">Fürdőszobák</label>
						<input id="baths" type="number" min="0" step="0.5" placeholder="2">
					</div>
					<div class="col-2">
						<label for="areaM2">Alapterület (m²)</label>
						<input id="areaM2" type="number" min="0" step="1" placeholder="120">
					</div>
					<div class="col-6">
						<label for="address">Cím</label>
						<input id="address" placeholder="Magyar utca 1.">
					</div>
					<div class="col-3">
						<label for="city">Város</label>
						<input id="city" placeholder="Mosonmagyaróvár">
					</div>
					<div class="col-3">
						<label for="state">Megye/Ország</label>
						<input id="state" placeholder="Győr-Moson-Sopron, Magyarország">
					</div>
					<div class="col-6">
						<label for="desc">Leírás</label>
						<textarea id="desc" placeholder="Rövid leírás az ingatlanról"></textarea>
					</div>
				</div>
				<div class="actions">
					<button id="saveBtn" class="btn">Mentés</button>
					<span id="status" class="status"></span>
				</div>
			</div>
			<div class="card">
				<h2>Fotók</h2>
				<div class="uploader" id="drop">
					<div class="hint">Húzza ide a fotókat, vagy</div>
					<label class="btn-mini" for="photos">Tallózás</label>
					<input id="photos" type="file" accept="image/*" multiple>
					<div class="meta"><span id="photoCount">0 kiválasztva</span><span>Legfeljebb 10 kép • max. ~5MB/kép</span></div>
				</div>
				<div class="previews" id="previews"></div>
			</div>
		</div>
	</div>
	<script>
	const BIN_ID = '68add1c9ae596e708fd72498'
	const MASTER_KEY = '$2a$10$9sO/ja29sMebpWNvsWmp5.dJ6lv7CPeLBMRFaA/cAEwz42ii6qlCS'
	const BASE_URL = 'https://api.jsonbin.io/v3/b/' + BIN_ID
	const IMGBB_KEY = 'aedade0e0aed06accc870f38c2558577'
	const EUR_TO_HUF = 390
	const SQFT_PER_M2 = 10.7639
	const statusEl = document.getElementById('status')
	const saveBtn = document.getElementById('saveBtn')
	const drop = document.getElementById('drop')
	const inputPhotos = document.getElementById('photos')
	const previews = document.getElementById('previews')
	const photoCount = document.getElementById('photoCount')
	let queuedFiles = []

	function setStatus(msg, type) {
		statusEl.textContent = msg;
		statusEl.className = 'status ' + (type || '')
	}

	function uid() {
		if(crypto.randomUUID) {
			return crypto.randomUUID()
		}
		return Date.now().toString(36) + Math.random().toString(36).slice(2)
	}

	function val(id) {
		return document.getElementById(id).value.trim()
	}

	function fileToPreview(file) {
		return new Promise((res, rej) => {
			const r = new FileReader();
			r.onload = () => res(r.result);
			r.onerror = rej;
			r.readAsDataURL(file)
		})
	}
	async function fileToBase64(file) {
		const data = await fileToPreview(file);
		return String(data).split(',')[1]
	}

	function renderPreviews() {
		previews.innerHTML = '';
		photoCount.textContent = queuedFiles.length + ' kiválasztva';
		queuedFiles.forEach((f, i) => {
			const wrap = document.createElement('div');
			wrap.className = 'preview';
			const img = document.createElement('img');
			img.src = f.preview;
			const rm = document.createElement('button');
			rm.className = 'rm';
			rm.textContent = 'Eltávolítás';
			rm.onclick = () => {
				queuedFiles.splice(i, 1);
				renderPreviews()
			};
			wrap.appendChild(img);
			wrap.appendChild(rm);
			previews.appendChild(wrap)
		})
	}

	function addFiles(files) {
		for(const f of files) {
			if(!f.type.startsWith('image/')) continue;
			if(queuedFiles.length >= 10) break;
			queuedFiles.push({
				file: f,
				preview: '',
				uploadedUrl: null
			})
		}
		Promise.all(queuedFiles.map(async q => {
			if(!q.preview) q.preview = await fileToPreview(q.file)
		})).then(renderPreviews)
	}
	drop.addEventListener('dragover', e => {
		e.preventDefault();
		drop.style.borderColor = '#f59e0b'
	});
	drop.addEventListener('dragleave', () => {
		drop.style.borderColor = 'var(--border)'
	});
	drop.addEventListener('drop', e => {
		e.preventDefault();
		drop.style.borderColor = 'var(--border)';
		addFiles(e.dataTransfer.files)
	})
	inputPhotos.addEventListener('change', e => addFiles(e.target.files))
	async function compressImage(file, max = 1600, quality = .86) {
		const dataUrl = await fileToPreview(file)
		const img = new Image();
		img.decoding = 'async';
		img.src = dataUrl;
		await img.decode()
		const scale = Math.min(1, max / Math.max(img.width, img.height))
		const canvas = document.createElement('canvas');
		canvas.width = Math.round(img.width * scale);
		canvas.height = Math.round(img.height * scale)
		const ctx = canvas.getContext('2d');
		ctx.drawImage(img, 0, 0, canvas.width, canvas.height)
		const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', quality))
		return new File([blob], (file.name || 'photo') + '.jpg', {
			type: 'image/jpeg'
		})
	}
	async function uploadImage(file) {
		if(!IMGBB_KEY) throw new Error('Adja meg az IMGBB API kulcsot')
		const base64 = await fileToBase64(file)
		const fd = new FormData()
		fd.append('image', base64)
		const r = await fetch('https://api.imgbb.com/1/upload?key=' + encodeURIComponent(IMGBB_KEY), {
			method: 'POST',
			body: fd
		})
		const j = await r.json()
		if(!r.ok || !j || !j.data || !j.data.display_url) throw new Error('Feltöltés sikertelen')
		return j.data.display_url
	}
	async function uploadPhotos() {
		const urls = []
		for(const q of queuedFiles) {
			if(q.uploadedUrl) {
				urls.push(q.uploadedUrl);
				continue
			}
			const small = await compressImage(q.file)
			const url = await uploadImage(small)
			q.uploadedUrl = url;
			urls.push(url)
		}
		return urls
	}
	async function fetchListings() {
		const res = await fetch(BASE_URL + '/latest', {
			headers: {
				'X-Master-Key': MASTER_KEY,
				'Content-Type': 'application/json'
			}
		})
		if(!res.ok) {
			if(res.status === 404) return [];
			throw new Error('Betöltési hiba')
		}
		const j = await res.json();
		return Array.isArray(j.record) ? j.record : []
	}
	async function saveListings(arr) {
		const res = await fetch(BASE_URL, {
			method: 'PUT',
			headers: {
				'X-Master-Key': MASTER_KEY,
				'Content-Type': 'application/json'
			},
			body: JSON.stringify(arr)
		})
		if(!res.ok) throw new Error('Mentési hiba')
	}
	saveBtn.addEventListener('click', async () => {
		const title = val('title'),
			priceStr = val('price'),
			currency = document.getElementById('currency').value,
			type = document.getElementById('type').value,
			beds = val('beds'),
			baths = val('baths'),
			areaM2Str = val('areaM2'),
			address = val('address'),
			city = val('city'),
			state = val('state'),
			desc = val('desc')
		if(!title || !priceStr || !currency || !type || !beds || !baths || !areaM2Str || !address || !city || !state) {
			setStatus('Kérjük, töltsön ki minden mezőt', 'err');
			return
		}
		const priceOriginal = Number(priceStr)
		const priceEUR = currency === 'EUR' ? priceOriginal : priceOriginal / EUR_TO_HUF
		const areaM2 = Number(areaM2Str)
		const areaSqft = Math.round(areaM2 * SQFT_PER_M2)
		saveBtn.disabled = true;
		setStatus('Fotók feltöltése...')
		try {
			const photos = await uploadPhotos()
			setStatus('Mentés folyamatban...')
			const list = await fetchListings()
			const item = {
				id: uid(),
				title,
				price: priceEUR,
				priceEUR,
				priceOriginal,
				currency,
				propertyType: type,
				bedrooms: Number(beds),
				bathrooms: Number(baths),
				area: areaSqft,
				areaM2Original: areaM2,
				address,
				city,
				state,
				description: desc,
				photos,
				createdAt: new Date().toISOString()
			}
			list.push(item)
			await saveListings(list)
			setStatus('Sikeres mentés', 'ok')
			document.getElementById('title').value = '';
			document.getElementById('price').value = '';
			document.getElementById('currency').value = 'HUF';
			document.getElementById('type').value = '';
			document.getElementById('beds').value = '';
			document.getElementById('baths').value = '';
			document.getElementById('areaM2').value = '';
			document.getElementById('address').value = '';
			document.getElementById('city').value = '';
			document.getElementById('state').value = '';
			document.getElementById('desc').value = ''
			queuedFiles = [];
			renderPreviews();
			photoCount.textContent = '0 kiválasztva'
		} catch (e) {
			setStatus('Hiba: ' + (e && e.message ? e.message : 'Nem sikerült menteni'), 'err')
		} finally {
			saveBtn.disabled = false
		}
	})
	</script>
</body>

</html>
